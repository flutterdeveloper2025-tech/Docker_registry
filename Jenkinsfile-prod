pipeline {
    agent any

    environment {
        DOCKER_HUB = "anas025"                   // Docker Hub username
        IMAGE_NAME = "for-docker-app"            // Docker Hub repo name
        IMAGE_TAG  = "prod-${BUILD_NUMBER}"      // Version tag (auto from Jenkins)
        FULL_IMAGE = "${DOCKER_HUB}/${IMAGE_NAME}:${IMAGE_TAG}"
        BACKUP = "${DOCKER_HUB}/${IMAGE_NAME}:prod-last" // last working image
        LATEST_IMAGE  = "${DOCKER_HUB}/${IMAGE_NAME}:prod-latest" // latest stable image
        NAMESPACE = "prod"                        // Kubernetes namespace
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/flutterdeveloper2025-tech/Docker_registry.git'
            }
        }

        stage('Approval for PROD') {
            steps {
                input message: 'Deploy to PROD?'
            }
        }

        stage('Build Docker Image') {
            steps {
                sh "docker build -t $FULL_IMAGE ."
            }
        }

        stage('Docker Login') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'docker_registry_prod',
                    usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                    sh "echo $PASS | docker login -u $USER --password-stdin"
                }
            }
        }

        stage('Push Image to Docker Hub') {
            steps {
                sh "docker push $FULL_IMAGE"
            }
        }

        stage('Deploy to Kubernetes PROD') {
            steps {
                // Update prod deployment file with new image
                sh "sed -i 's|image:.*|image: $FULL_IMAGE|' k8s/prod-deployment.yaml"
                
                // Apply deployment and service
                sh "kubectl apply -f k8s/prod-deployment.yaml -n $NAMESPACE"
                sh "kubectl apply -f k8s/prod-service.yaml -n $NAMESPACE"
            }
        }

        stage('Smoke Test') {
            steps {
                script {
                    try {
                        sh """
                        EXTERNAL_IP=\$(kubectl get svc mywebsite-service -n $NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
                        STATUS=\$(curl -o /dev/null -s -w "%{http_code}" http://\$EXTERNAL_IP)
                        if [ "\$STATUS" != "200" ]; then
                            exit 1
                        fi
                        """
                    } catch (err) {
                        echo "‚ö†Ô∏è Rolling back to last working image"
                        sh """
                        kubectl set image deployment/mywebsite mywebsite=$BACKUP -n $NAMESPACE
                        """
                        error("‚ùå Deployment failed, rolled back")
                    }
                }
            }
        }
    }

    post {
        success {
            echo "üéâ PROD deployment to Kubernetes successful"
            mail to: 'flutterdeveloper2025@gmail.com',
                 subject: "‚úÖ PROD Deployment SUCCESS: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                 body: "The PROD deployment completed successfully.\nCheck Jenkins console: ${env.BUILD_URL}"
        }
        failure {
            echo "‚ùå PROD deployment failed"
            mail to: 'flutterdeveloper2025@gmail.com',
                 subject: "‚ùå PROD Deployment FAILED: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                 body: "The PROD deployment failed.\nCheck Jenkins console: ${env.JUILD_URL}"
        }
    }
}
